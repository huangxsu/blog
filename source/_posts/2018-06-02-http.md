---
title:  HTTP协议（下）
date: 2018-06-02 11:10:00
tags:
- HTTP
- HTTPS
---

重要的 HTTP 协议，很重要。《图解 HTTP》读书笔记，作者：上野 宣，译者：于均良。

<!--more-->

# 与 HTTP 写作的 Web 服务器

## 多域名虚拟主机

{% asset_img virtual-host.png 虚拟主机 %}

HTTP/1.1 规范允许一台 HTTP 服务器搭建多个 Web 站点。客户端使用 HTTP 协议访问服务器时，经常采用类型 www.abc.com 这样的主机域名。域名通过 DNS 服务映射到 IP 地址之后访问目标网站。在相同的 IP 地址下，由于虚拟主机可以寄存多个不同的主机域名，因为发送 HTTP 请求是，必须在 Host 首部内指定主机域名的 URI。

## 通信数据转发程序：代理、网关、隧道

1.  代理 是一种又转发功能的应用程序，扮演了位于服务器和客户端“中间人”的角色，使用代理服务器的理由有：利用缓存技术减少网络带宽流量；对特定网站的访问控制；获取访问日志。

缓存代理：代理转发响应时，缓存代理会预先将资源的副本保存在代理服务器上。当再次接收到相同资源请求是，就可以不从源服务器那里获取，将之前缓存的资源作为响应返回。

透明代理：转发请求或响应是，不对报文做任何加工被称为透明代理。

2.  网关 是转发其他服务器通信数据的服务器。

3.  隧道 在相隔甚远的客户端和服务器之间进行中转，并保持双方通信链接的应用程序。目的是确保客户端和服务器进行安全的通信。

## 缓存

缓存是指代理服务器或客户端本地磁盘内保存资源副本。利用缓存可减少对源服务器的访问，节省通信流量和通信时间。

1.  缓存服务器 是代理服务器的一种
2.  客户端缓存（浏览器）
3.  有效期 缓存失效， 会再次请求新资源。

# 确保 Web 安全的 HTTPS

## HTTP 的缺点

1、 通信使用明文（不加密），内容可能会被窃听

加密处理防止被窃听：

1.  通信加密 HTTP 协议没有加密机制，但可以通过和 SSL（Secure Socket Layer，安全套接层）或 TLS（Transport Layer Security，安全层传输协议）的组合使用，加密 HTTP 的通信内容。与 SSL 组合使用的 HTTP 被称为 HTTPS。

2.  内容加密 为了做到有效的内容加密，前提是要求客户端和服务器同事具备加密和解密机制。

2、 不验证通信方的身份，因此有可能能遭遇伪装

任何人都可以发起请求：即使是无意义的请求也会照单全收，无法阻止海量请求下的 Dos 攻击（Denial of Service， 拒绝服务攻击）。

查明对手的证书：

虽然使用 HTTP 协议无法确定通信方，但如果使用 SSL 则可以。SSL 提供了一种证书方法可用于确定对方身份。

证书由值得信任的第三方机构颁发，用以证明服务器和客户端是实际存在的。

3、 无法证明报文的完整性，所以有可能已遭篡改

## HTTP + 加密 + 认证 + 完整性保护 = HTTPS

1、 HTTPS 是身批 SSL 外壳的 HTTP

通常，HTTP 直接和 TCP 通信。当使用 SSL 时，先和 SSL 通信，再有 SSL 和 TCP 通信。SSL 独立于 HTTP 协议，不仅 HTTP 协议，其他运行在应用层的 SMTP 和 Telent 等协议均可配合 SSL 协议使用。

{% asset_img HTTPS.png HTTPS %}

2、 对称密钥和非对称密钥加密

1.  对称密钥加密（共享密钥）技术 加密和解密使用的是同一个密钥
2.  非对称加密（公开密钥）技术 两个密钥，私有密钥和公开密钥。发送密文一方使用对方的公开密钥加密，对方收到密文后，使用自己的私有密钥解密。

3、 HTTPS 采用混合加密机制

非对称密钥安全性高，但是速度比对称秘钥慢。所以，在交换密钥环节使用公开密钥方法，之后建立通信交换报文阶段使用共享密钥，既保证安全又提升效率。

4、 证明公开密钥正确性的证书

为了确保公开密钥在传输图中没有被掉包，可以使用右数字认证机构（CA, Certificate Authority）颁发的公开密钥证书。服务器将证书发送给客户端，客户端使用 CA 的公开密钥校验证书。浏览器开发商或事先在内部植入常用认证机关的公开密钥，保证认证机关的密钥是安全可靠的。

5、 HTTPS 的安全通信机制

{% asset_img SSL.png SSL %}

1.  客户端向服务器发出加密通信请求（ClientHello），并向服务器提供：支持的协议版本；一个随机数（Client random）；支持加密的方法；支持压缩的方法。
2.  服务器回应（ServerHello）：确认使用的加密通信协议版本；一个随机数（Server random）；确认使用的加密方法；服务器证书。
3.  客户端收到服务器回应后，首先验证证书，通过后取出公钥，向服务器发送：一个用公钥加密的随机数（Premaster secret）；编码改变通知（表示随后的信息将用双方商定的加密方式和密钥发送）；客户端握手结束（这一项同时也是前面发送的所有内容的 hash 值，供服务器校验）。
4.  服务器的最后回应，服务器使用私钥获取 Premaster secret 之后，计算生产本次会话所有的“会话密钥（对称秘钥）”，向客户端发送：编码改变通知；服务器握手结束通知。

接下来，客户端和服务器使用“会话秘钥”进入加密通信。

{% asset_img SSL-Handshake.png SSL Handshake %}

6、 SSL 和 TLS

SSL 技术最初是由浏览器开发商网景通信公司率先倡导的， 开发过 SSL3.0 之前的版本。 目前主导权已转移到 IETF（Internet Engineering Task Force， Internet 工程任务组） 的手中。

IETF 以 SSL3.0 为基准， 后又制定了 TLS1.0、 TLS1.1 和 TLS1.2。 TSL 是以 SSL 为原型开发的协议， 有时会统一称该协议为 SSL。 当前主流的版本是 SSL3.0 和 TLS1.0

7、 SSL 速度慢吗

1.  通信慢。和 HTTP 相比，出去 TCP 连接、发送 HTTP 请求、响应之外，还要进行 SSL 通信
2.  必须进行加密解密处理。比起 HTTP 会更多的消耗服务器和客户端的硬件资源。

# 参考文献

1.  **[阮一峰 SSL/TLS 协议运行机制的概述](http://www.ruanyifeng.com/blog/2014/02/ssl_tls.html)**
2.  **[阮一峰 图解 SSL/TLS 协议](http://www.ruanyifeng.com/blog/2014/09/illustration-ssl.html)**
